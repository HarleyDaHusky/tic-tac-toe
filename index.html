<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Tic-Tac-Toe</title>
    <link rel="stylesheet" href="public/styles.css">
    <style>
    /* minimal fallback if styles.css missing */
    #board { display:grid; grid-template-columns:repeat(3,80px); gap:5px; justify-content:center; margin:20px auto; }
    .cell { width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:2rem; background:#eee; cursor:pointer; border:1px solid #ccc; }
  </style>
</head>
<body>
    <h1>Live Tic-Tac-Toe</h1>
    <div>
        <input id="gameId" placeholder="Game ID">
        <input id="playerId" placeholder="Your Name">
        <button onclick="createGame()">Create Game</button>
        <button onclick="joinGame()">Join Game</button>
    </div>
    <div id="status"></div>
    <div id="turn"></div>
    <div id="board"></div>
    <button id="rematchBtn" style="display:none;" onclick="requestRematch()">Rematch?</button>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        let gameId = '';
        let playerId = '';
        let myTurn = false;
        let board = Array(9).fill('');
        let gameStarted = false;
        let rematchVotes = 0;

        function createGame() {
            gameId = document.getElementById('gameId').value;
            playerId = document.getElementById('playerId').value;
            socket.emit('createGame', { gameId });
            socket.emit('joinGame', { gameId, playerId });
        }

        function joinGame() {
            gameId = document.getElementById('gameId').value;
            playerId = document.getElementById('playerId').value;
            socket.emit('joinGame', { gameId, playerId });
        }

        socket.on('gameCreated', data => {
            document.getElementById('status').innerText = `Game ${data.gameId} created. Waiting for opponent...`;
            gameStarted = false;
            showBoard(false);
        });

        socket.on('gameJoined', data => {
            document.getElementById('status').innerText = `Joined game ${data.gameId}. Waiting for opponent...`;
            gameStarted = false;
            showBoard(false);
        });

        // Helper to set turn indicator and myTurn
        function setInitialTurn(first_player) {
            if (playerId === first_player) {
                document.getElementById('turn').innerText = 'Your turn!';
                myTurn = true;
            } else {
                document.getElementById('turn').innerText = 'Waiting for opponent...';
                myTurn = false;
            }
        }

        // Custom event: both players joined, start game
        socket.on('startGame', data => {
            document.getElementById('status').innerText = `Game started!`;
            gameStarted = true;
            showBoard(true);
            setInitialTurn(data.first_player);
            document.getElementById('rematchBtn').style.display = 'none';
            document.getElementById('rematchBtn').disabled = false;
            board = Array(9).fill('');
            renderBoard();
        });

        socket.on('moveMade', data => {
            board = data.result.board;
            renderBoard();
            if (data.result.winner) {
                document.getElementById('status').innerText = `Winner: ${data.result.winner}`;
                document.getElementById('turn').innerText = '';
            } else if (data.next_player === playerId) {
                document.getElementById('turn').innerText = 'Your turn!';
                myTurn = true;
            } else {
                document.getElementById('turn').innerText = 'Waiting for opponent...';
                myTurn = false;
            }
        });

        socket.on('gameOver', data => {
            // Show "Draw" when draw flag is true, otherwise show the winner
            if (data && data.draw) {
                document.getElementById('status').innerText = 'Draw';
            } else {
                document.getElementById('status').innerText = `Winner: ${data && data.winner ? data.winner : 'Unknown'}`;
            }
            document.getElementById('turn').innerText = '';
            gameStarted = false;
            // keep the board visible and show rematch button
            document.getElementById('rematchBtn').style.display = 'inline-block';
        });

        socket.on('error', data => {
            document.getElementById('status').innerText = data.message;
        });

        function showBoard(show) {
            document.getElementById('board').style.display = show ? 'grid' : 'none';
        }

        function renderBoard() {
            const boardDiv = document.getElementById('board');
            boardDiv.innerHTML = '';
            board.forEach((cell, idx) => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'cell';
                cellDiv.innerText = cell;
                cellDiv.onclick = () => {
                    if (gameStarted && myTurn && cell === '') makeMove(idx);
                };
                boardDiv.appendChild(cellDiv);
            });
        }

        function makeMove(position) {
            socket.emit('makeMove', { gameId, playerId, position });
        }

        function updateTurn(data) {
            // If no data, default to player 1's turn
            if (!data || !data.result || !data.result.board) {
                myTurn = true;
                document.getElementById('turn').innerText = 'Your turn!';
                return;
            }
            // Count X and O to determine turn
            const xCount = data.result.board.filter(c => c === 'X').length;
            const oCount = data.result.board.filter(c => c === 'O').length;
            // If X's turn and you are player 1, or O's turn and you are player 2
            if ((xCount === oCount && playerId === data.player) || (xCount > oCount && playerId !== data.player)) {
                myTurn = true;
                document.getElementById('turn').innerText = 'Your turn!';
            } else {
                myTurn = false;
                document.getElementById('turn').innerText = 'Waiting for opponent...';
            }
        }

        function requestRematch() {
            socket.emit('rematchRequest', { gameId, playerId });
            document.getElementById('rematchBtn').disabled = true;
            document.getElementById('status').innerText = 'Waiting for opponent to accept rematch...';
        }

        socket.on('rematchStatus', data => {
            if (data.votes < 2) {
                document.getElementById('status').innerText = 'Waiting for opponent to accept rematch...';
            }
            // Do NOT reset the board or call setInitialTurn here!
            // The reset and turn assignment will happen in the startGame handler.
        });

        // Initial state
        showBoard(false);
    </script>
</body>
</html>